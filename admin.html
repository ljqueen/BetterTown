<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - BetterTown</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-panel { max-width: 700px; margin: 2rem auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #185a9d22; padding: 2.5rem; }
        .admin-panel h2 { color: #185a9d; margin-top: 2rem; }
        .admin-panel ul { margin-bottom: 2rem; }
        .admin-panel li { margin-bottom: 0.7rem; font-size: 1.1rem; }
        .admin-section { margin-bottom: 2.5rem; }
        .admin-btn { background: #43cea2; color: #fff; font-weight: 700; border: none; border-radius: 8px; padding: 0.6rem 1.5rem; margin: 0.5rem 0.7rem 0.5rem 0; cursor: pointer; transition: background 0.2s; }
        .admin-btn:hover { background: #185a9d; }
        .admin-username-header {
            display: none;
        }
    </style>
</head>
<body onload="adminAuth()">
    <nav class="navbar">
        <div class="navbar-logo">BetterTown</div>
        <ul class="navbar-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="services.html">Programs</a></li>
            <li><a href="location.html">Our Location</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
    </nav>
    <header>
        <h1>Admin Panel</h1>
    </header>
    <main>
        <section class="admin-panel">
            <div style="background:#fffbe7;border:2px solid #ffd700;padding:1.2rem 1rem 1.2rem 1rem;border-radius:10px;margin-bottom:2rem;color:#b8860b;font-weight:700;font-size:1.1rem;text-align:center;">
                <span>Notice: Any major changes to the website or data require explicit permission from BetterTown Corporate. Unauthorized changes may result in loss of access or other actions.</span>
            </div>
            <h2>Admin Tools</h2>
            <div class="admin-section">
                <button class="admin-btn" onclick="window.open('sign-ups.html','_self')">Manage Sign-Ups</button>
                <button class="admin-btn" onclick="window.print()">Print This Page</button>
            </div>
            <div class="admin-section">
                <h3>Export Data</h3>
                <button class="admin-btn" onclick="exportSignupsCSV()">Export Sign-Ups to CSV</button>
            </div>
            <div class="admin-section">
                <h3>Admin Log (Local)</h3>
                <ul id="admin-log-list"></ul>
            </div>
            <div class="admin-section">
                <h3>Other Tools</h3>
                <button class="admin-btn" onclick="clearSignups()">Clear All Sign-Ups</button>
                <button class="admin-btn" onclick="restoreDeleted()">Restore Deleted Sign-Ups</button>
            </div>
            <div class="admin-section">
                <!-- Admin management moved to district page -->
            </div>
            <div class="admin-section">
                <h3>Sign-Ups Management</h3>
                <button class="admin-btn" onclick="window.open('sign-ups.html','_self')">View Sign-Ups</button>
            </div>
            <div class="admin-section">
                <h3>District Login</h3>
                <form id="district-login-form" onsubmit="districtLogin(event)" style="max-width:320px;margin:0 auto;">
                    <input type="text" id="district-username" placeholder="District Username" required style="width:100%;margin-bottom:0.7rem;">
                    <input type="password" id="district-password" placeholder="District Password" required style="width:100%;margin-bottom:0.7rem;">
                    <button class="admin-btn" type="submit">District Login</button>
                </form>
                <div id="district-login-success" style="display:none;color:#185a9d;font-weight:bold;margin-top:1rem;">District login successful!</div>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 BetterTown. All rights reserved.</p>
        <div id="admin-username-footer" style="margin-top:0.7rem;font-size:1.1rem;color:#fff;font-weight:bold;"></div>
    </footer>
    <script>
    function adminAuth() {
        var allowed = sessionStorage.getItem('btown_admin');
        if (allowed === 'yes') return;
        var pass = prompt('Admin access only. Please enter the password:');
        if (pass === '9311') {
            sessionStorage.setItem('btown_admin', 'yes');
        } else {
            alert('Access denied.');
            window.location.href = 'index.html';
        }
    }
    // Export sign-ups to CSV
    function exportSignupsCSV() {
        const signups = JSON.parse(localStorage.getItem('bettertow_signup_list') || '[]');
        if (!signups.length) { alert('No sign-ups to export.'); return; }
        const header = ['Program','Location','Email','Age'];
        const rows = signups.map(s => [s.program, s.location, s.email, s.age]);
        let csv = header.join(',') + '\n' + rows.map(r => r.map(x => '"'+(x||'')+'"').join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'bettertow_signups.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        logAdmin('Exported sign-ups to CSV');
    }
    // Admin log
    function logAdmin(msg) {
        let user = sessionStorage.getItem('btown_admin_user') || 'unknown';
        let log = JSON.parse(localStorage.getItem('btown_admin_log') || '[]');
        log.push({msg, user, time: new Date().toLocaleString()});
        localStorage.setItem('btown_admin_log', JSON.stringify(log));
        renderAdminLog();
    }
    function renderAdminLog() {
        let log = JSON.parse(localStorage.getItem('btown_admin_log') || '[]');
        const list = document.getElementById('admin-log-list');
        list.innerHTML = log.length ? log.map(l => `<li>${l.time} [${l.user}]: ${l.msg}</li>`).join('') : '<li>No admin actions yet.</li>';
    }
    // Clear all sign-ups
    function clearSignups() {
        var pass = prompt('To clear all sign-ups, please enter the admin password:');
        if (pass !== 'BetterTown2025') {
            alert('Incorrect password. Action cancelled.');
            return;
        }
        if (!confirm('Are you sure you want to delete ALL sign-ups?')) return;
        let signups = JSON.parse(localStorage.getItem('bettertow_signup_list') || '[]');
        if (signups.length) localStorage.setItem('bettertow_deleted', JSON.stringify(signups));
        localStorage.setItem('bettertow_signup_list', '[]');
        logAdmin('Cleared all sign-ups');
        alert('All sign-ups deleted.');
    }
    // Restore deleted sign-ups
    function restoreDeleted() {
        let deleted = JSON.parse(localStorage.getItem('bettertow_deleted') || '[]');
        if (!deleted.length) { alert('No deleted sign-ups to restore.'); return; }
        localStorage.setItem('bettertow_signup_list', JSON.stringify(deleted));
        localStorage.setItem('bettertow_deleted', '[]');
        logAdmin('Restored deleted sign-ups');
        alert('Deleted sign-ups restored.');
    }
    // Patch login to set user
    const origLogin = window.loginAdmin;
    window.loginAdmin = function(e) {
        e.preventDefault();
        var user = document.getElementById('login-username').value.trim();
        var pass = document.getElementById('login-password').value;
        var error = document.getElementById('login-error');
        let admins = JSON.parse(localStorage.getItem('btown_admin_accounts') || '[]');
        if (admins.some(a => a.username === user && a.password === pass)) {
            sessionStorage.setItem('btown_admin', 'yes');
            sessionStorage.setItem('btown_admin_user', user);
            window.location.href = 'admin.html';
            return false;
        } else {
            error.textContent = 'Incorrect username or password.';
            error.style.display = 'block';
            return false;
        }
    }
    window.onload = function() {
        renderAdminLog();
        renderAdminAccounts();
        showAdminAccountSection();
    }
    // Show logged-in admin username in footer
    (function() {
        var user = sessionStorage.getItem('btown_admin_user');
        if (user) {
            document.getElementById('admin-username-footer').textContent = 'Logged in as: ' + user;
        }
    })();
    // Show logged-in admin username at the top of the admin page
    document.addEventListener('DOMContentLoaded', function() {
        var el = document.getElementById('admin-username-text');
        // Try to get username from sessionStorage, fallback to login prompt if missing
        var user = sessionStorage.getItem('btown_admin_user');
        if (!user) {
            user = prompt('Session expired. Please enter your admin username:');
            if (user) sessionStorage.setItem('btown_admin_user', user);
        }
        if (el && user) {
            el.textContent = user;
        } else if (el) {
            el.textContent = '[unknown]';
        }
    });
    function districtLogin(e) {
        e.preventDefault();
        var user = document.getElementById('district-username').value.trim();
        var pass = document.getElementById('district-password').value;
        if (user === 'ljqueen' && pass === '9311') {
            window.location.href = 'district.html';
        } else {
            alert('District login failed.');
        }
    }
    </script>
</body>
</html>
